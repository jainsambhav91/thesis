<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.34.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.34.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        /*#map { position:absolute; top:0; bottom:0; width:100%; }*/
    </style>
</head>
<body>

<style>
    .calculation-box {
        height: 140px;
        width: 150px;
        position: absolute;
        top: 210px;
        left: 10px;
        background-color: rgba(255, 255, 255, .9);
        padding: 15px;
        text-align: center;
    }

    #calculate {
        min-height: 20px;
        background-color: #3887be;
        color: #fff;
        font-family: 'Open Sans';
        border-radius: 5px;
        padding: 10px;
        cursor: pointer;
        margin: 10px 0;
    }
    #map{
        height: 500px;
        width: 900px;
    }
    
    #map2{
        height: 500px;
        width: 900px;
    }
    
    p {
        font-family: 'Open Sans';
        margin: 0;
        font-size: 13px;
    }
    
    #geocoder-container > div {
    min-width:50%;
    margin-left:25%;
}
</style>

<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v0.17.0/mapbox-gl-draw.js'></script>
<script type="text/javascript" src="chicago_basemap_april14.js"></script>
<script type="text/javascript" src="parks_april14.js"></script>
<script type="text/javascript" src="parks_april14_buffer_epsg.js"></script>
<script type="text/javascript" src="parks_april14_buffer_dissolved_epsg.js"></script>
<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script> 
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v0.17.0/mapbox-gl-draw.css' type='text/css'/>

<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.css' type='text/css' />

<h2>Map 1: Residence and Employment Restrictions</h2>

<div id='map' onmouseup="recalculate()"></div>

<div class='calculation-box'>
    <p>Draw a polygon using the draw tools.</p>
    <div id='calculate' class='button button'>Calculate area</div>
    <div id='calculated-area'></div>
</div>

<h2>Map 2: Mobility and Presence Restrictions</h2>

<div id='map2' onmouseup="recalculate()"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiamFpbnNhbWJoYXYiLCJhIjoiY2l1aW5uOTZ5MDAwOTJvcGxrMWg4OHUxciJ9.X8mAbHJEKa78PHXfVRK5-Q';
/* eslint-disable */
var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/satellite-v9', //hosted style id
    center: [-87.623177, 41.881832], // starting position
    zoom: 10 // starting zoom
});


map.on('load', function () {

    map.addLayer({
        'id': 'chicago',
        'type': 'fill',
        'source': {
            'type': 'geojson',
            'data': chicagoBaseMap
        },
        'layout': {},
        'paint': {
            'fill-color': '#088',
            'fill-opacity': 0.8
        }
    });
});
// var f1 = totalArea.features;
var f1 = chicagoBaseMap.features;
// console.log(f1);

// var parksBuffer = turf.buffer(parks, 500, 'feet');
// var parksBufferDissolve = turf.dissolve(parksBuffer);

map.on('load', function () {

    map.addLayer({
        'id': 'school',
        'type': 'fill',
        'source': {
            'type': 'geojson',
            'data': parksBufferDissolved_epsg
        },
        'layout': {},
        'paint': {
            'fill-color': '#d9f442',
            'fill-opacity': 0.5
        }
    });
});

var f2 = parksBufferDissolved_epsg.features;

var point00 = [0, 0];
var point01 = [0, 900];
var point11 = [900, 900];
var point10 = [900, 0];

// console.log("North West Point : " + latlngNW);
// console.log("South East Point : " + latlngSE);

    // var bbox = [0, 0, 500, 500];

// var draw = new MapboxDraw({
//     displayControlsDefault: false,
//     controls: {
//         polygon: true,
//         trash: true
//     }
// });
// map.addControl(draw);

function recalculate() {
    var latlng00 = map.unproject(point00);
    var latlng01 = map.unproject(point01);
    var latlng11 = map.unproject(point11);
    var latlng10 = map.unproject(point10);
    

    var bbox = {
                  "type": "Polygon",
                  "coordinates": [
                    [
                      [latlng00.lng, latlng00.lat],
                      [latlng01.lng, latlng01.lat],
                      [latlng11.lng, latlng11.lat],
                      [latlng10.lng, latlng10.lat],
                      [latlng00.lng, latlng00.lat]
                    ]
                  ]
                }

        // console.log(bbox);
    
        var data = turf.featureCollection(bbox);
        // console.log(data);
        
        // var dissolvedData = turf.dissolve(data);
        // console.log(dissolved);
        
        
        conflictlist1 = [];
        conflictlist2 = [];

        for (var i = 0; i < f1.length; i++) {
            var parcel1 = f1[i];
        
                    var conflict = turf.intersect(parcel1.geometry, data.features);
                    if (conflict != null) {
                        conflictlist1.push(conflict);
            }
        }
        
        for (var i = 0; i < f2.length; i++) {
            var parcel2 = f2[i];

                    var conflict2 = turf.intersect(parcel2.geometry, data.features);
                    if (conflict2 != null) {
                        conflictlist2.push(conflict2);
                    }
        }
        
        
        var intersectionBase = turf.featureCollection(conflictlist1);
        var intersectionSchool = turf.featureCollection(conflictlist2);
        
        var areaBase = turf.area(intersectionBase);
        var areaSchool = turf.area(intersectionSchool);
        
        var rounded_areaBase = Math.round(areaBase*100)/100;
        var rounded_areaSchool = Math.round(areaSchool*100)/100; 
        
        var answer = document.getElementById('calculated-area');
        var percentage = parseInt((rounded_areaSchool/rounded_areaBase)*100);
        answer.innerHTML = '<p><strong>' + percentage + '</strong></p><p>% Area prohibited</p> <br>  ';
}

var calcButton = document.getElementById('calculate');


var map2 = new mapboxgl.Map({
    container: 'map2', // container id
    style: 'mapbox://styles/mapbox/satellite-v9', //hosted style id
    center: [-87.623177, 41.881832], // starting position
    zoom: 10 // starting zoom
});

var geocoder1 = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken
});

var source = 0;

map2.addControl(geocoder1);

// After the map style has loaded on the page, add a source layer and default
// styling for a single point.
map2.on('load', function() {
    map2.addSource('single-point', {
        "type": "geojson",
        "data": {
            "type": "FeatureCollection",
            "features": []
        }
    });
    

    map2.addLayer({
        "id": "point",
        "source": "single-point",
        "type": "circle",
        "paint": {
            "circle-radius": 10,
            "circle-color": "#007cbf"
        }
    });
    
   

    // Listen for the `geocoder.input` event that is triggered when a user
    // makes a selection and add a symbol that matches the result.
    geocoder1.on('result', function(ev) {
        map2.getSource('single-point').setData(ev.result.geometry);
        if(source != ev.result.geometry){
            source = ev.result.geometry;
            drawLine();
        }
        // console.log(ev.result.geometry );
    });
    
});

function drawLine(){
    
}


</script>

</body>
</html>
